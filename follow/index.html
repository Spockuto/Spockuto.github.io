<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body onload="queryStringParse()">
<button id="github-follow" onclick="getAccessCode()">Follow</button>
<script type="text/javascript">

  var client_id     = 'e644584e5ceb8a2eb2c1';
  var client_secret = '9509bfb80f2faf2453553f4d8048519ddb263039';
  var redirect_uri  = 'http://www.venkkateshsekar.me/follow/';
  var origin        = 'http://www.venkkateshsekar.me' ;
  var random        = (Math.random() + 1).toString(36).substring(7);
  var username      = "lepture";
  function queryStringParse(){
    var code = getParameterByName("code");
    if(code){
      getAccessToken(code);
    }
  }
    
  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
    results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  function getAccessCode(){
    window.open("http://github.com/login/oauth/authorize?client_id="+ client_id 
    +"&scope=user:follow&redirect_uri=" + redirect_uri + "&state=" +random, "_self");
  }

  function getAccessToken(code){
    
    var xhr = new XMLHttpRequest();
    var url  = "https://crossorigin.me/http://github.com/login/oauth/access_token?client_id=" + client_id + "&client_secret=" + client_secret + 
    "&code=" + code + "&redirect_uri=" + redirect_uri + "&state=" + random;
      
    xhr.open('POST', url , true); 
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
    xhr.onreadystatechange = function () {
      if (xhr.readyState == 4) {
        if(xhr.status == 200){
          var access_token = xhr.responseText.slice(13,53);
          Follow(access_token);
        } 
        else {
          alert("Error loading page\n");
        }
      }
    };
      xhr.send(true);     
  }

  function Follow(access_token){

      var xmlHttp = new XMLHttpRequest(); 
      var mimeType = "text/plain";  
      
      if (document.getElementById("github-follow").innerHTML == "Follow"){
        xmlHttp.open('PUT', 'https://api.github.com/user/following/' + username, true);
        var changeText = "Unfollow";
      }
      else{
        xmlHttp.open('DELETE', 'https://api.github.com/user/following/' + username, true);
        var changeText = "Follow";
      }
      
      xmlHttp.setRequestHeader('Content-Type', mimeType);  
      xmlHttp.setRequestHeader('Authorization','token '+ access_token);
      xmlHttp.send(null);
      xmlHttp.onreadystatechange = function () {
      if (xmlHttp.readyState == 4) {
        if(xmlHttp.status == 204)
          document.getElementById("github-follow").innerHTML = changeText ;
        else
          window.open("https://www.github.com/" + username , "_self");
      }
    };
  } 
  </script>
</body>
</html>